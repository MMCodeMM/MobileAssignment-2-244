<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>主題清單</title>
    <!-- Ionic CDN -->
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <!-- 加上 style.css 連結 -->
    <link rel="stylesheet" href="./src/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />
  </head>
  <body>
    <ion-app>
      <ion-header>
        <ion-toolbar>
          <ion-title>運動教學</ion-title>
          <!-- 認證按鈕區域 -->
          <div slot="end" id="auth-section">
            <span
              id="user-welcome"
              style="display: none; margin-right: 12px; font-size: 14px"
            ></span>
            <ion-button id="login-btn" fill="outline" size="small"
              >登入</ion-button
            >
            <ion-button id="register-btn" fill="clear" size="small"
              >註冊</ion-button
            >
            <ion-button
              id="logout-btn"
              fill="outline"
              size="small"
              style="display: none"
              >登出</ion-button
            >
          </div>
        </ion-toolbar>

        <!-- 功能按鈕列 -->
        <ion-toolbar>
          <ion-searchbar placeholder="搜尋運動項目..."></ion-searchbar>
          <div slot="end" id="function-buttons">
            <ion-button
              id="favorites-btn"
              fill="clear"
              size="small"
              style="display: none"
            >
              <ion-icon name="heart-outline" slot="start"></ion-icon>
              收藏
            </ion-button>
            <ion-button
              id="show-all-btn"
              fill="clear"
              size="small"
              style="display: none"
            >
              <ion-icon name="list-outline" slot="start"></ion-icon>
              全部
            </ion-button>
          </div>
        </ion-toolbar>

        <ion-item>
          <ion-label></ion-label>
          <ion-select label="分類" interface="popover">
            <!-- 選項會由 script 動態生成，第一項為全部 (空值) -->
            <ion-select-option value="">全部</ion-select-option>
          </ion-select>
          <ion-button id="reset-category" fill="clear">重設</ion-button>
        </ion-item>
      </ion-header>

      <ion-content>
        <!-- 載入狀態指示器 -->
        <div
          id="loading-container"
          style="text-align: center; padding: 20px; display: none"
        >
          <ion-spinner name="crescent"></ion-spinner>
          <p style="margin-top: 10px">載入中...</p>
        </div>

        <!-- 錯誤訊息 -->
        <ion-card
          id="error-container"
          style="display: none; margin: 16px"
          color="danger"
        >
          <ion-card-content>
            <h3>載入失敗</h3>
            <p id="error-message"></p>
            <ion-button id="retry-btn" fill="outline" color="light"
              >重試</ion-button
            >
          </ion-card-content>
        </ion-card>

        <!-- 空狀態訊息 -->
        <div
          id="empty-state"
          style="text-align: center; padding: 40px; display: none"
        >
          <ion-icon
            name="fitness-outline"
            style="font-size: 64px; color: #ccc"
          ></ion-icon>
          <h3 style="color: #666">暫無資料</h3>
          <p style="color: #999">沒有找到相關的運動項目</p>
        </div>

        <div class="container">
          <ion-list>
            <!-- 清單項目範本 (會被 cloneNode) -->
            <ion-item class="list-item" style="display: none">
              <div class="item-content">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                  "
                >
                  <div style="flex: 1">
                    <div class="item-title">標題</div>
                    <div class="item-subtitle">副標題</div>
                    <div class="item-timeReq">所需時間</div>
                    <div class="item-equipment">工具</div>
                  </div>
                  <!-- 收藏按鈕 -->
                  <ion-button
                    class="favorite-btn"
                    fill="clear"
                    size="small"
                    style="display: none"
                  >
                    <ion-icon
                      class="favorite-icon"
                      name="heart-outline"
                    ></ion-icon>
                  </ion-button>
                </div>
                <img
                  class="item-image"
                  alt=""
                  style="
                    max-width: 100%;
                    height: auto;
                    display: block;
                    margin-top: 0.5rem;
                  "
                />
                <video
                  class="item-video"
                  controls
                  style="max-width: 100%; display: block; margin-top: 0.5rem"
                ></video>
                <div class="tag-container">
                  <!-- 標籤會於 script 動態加入 -->
                </div>
              </div>
            </ion-item>
          </ion-list>

          <!-- 載入更多按鈕 -->
          <div style="text-align: center; padding: 20px">
            <ion-button
              id="load-more-btn"
              expand="block"
              fill="outline"
              style="display: none"
            >
              <span class="load-more-text">載入更多</span>
              <ion-spinner style="display: none" name="crescent"></ion-spinner>
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ion-app>

    <!-- 登入模態框 -->
    <ion-modal id="login-modal">
      <ion-header>
        <ion-toolbar>
          <ion-title>用戶登入</ion-title>
          <ion-buttons slot="end">
            <ion-button id="close-login-modal">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <form id="login-form">
          <ion-item>
            <ion-label position="floating">用戶名</ion-label>
            <ion-input type="text" name="username" required></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">密碼</ion-label>
            <ion-input type="password" name="password" required></ion-input>
          </ion-item>
          <div class="ion-margin-top">
            <ion-button type="submit" expand="block" id="login-submit-btn">
              <span class="login-button-text">登入</span>
              <ion-spinner style="display: none" name="crescent"></ion-spinner>
            </ion-button>
          </div>
          <div
            id="login-error"
            style="color: red; margin-top: 10px; display: none"
          ></div>
        </form>
      </ion-content>
    </ion-modal>

    <!-- 註冊模態框 -->
    <ion-modal id="register-modal">
      <ion-header>
        <ion-toolbar>
          <ion-title>用戶註冊</ion-title>
          <ion-buttons slot="end">
            <ion-button id="close-register-modal">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <form id="register-form">
          <ion-item>
            <ion-label position="floating">用戶名</ion-label>
            <ion-input type="text" name="username" required></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">電子郵件</ion-label>
            <ion-input type="email" name="email" required></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">密碼</ion-label>
            <ion-input type="password" name="password" required></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">確認密碼</ion-label>
            <ion-input
              type="password"
              name="confirmPassword"
              required
            ></ion-input>
          </ion-item>
          <div class="ion-margin-top">
            <ion-button type="submit" expand="block" id="register-submit-btn">
              <span class="register-button-text">註冊</span>
              <ion-spinner style="display: none" name="crescent"></ion-spinner>
            </ion-button>
          </div>
          <div
            id="register-error"
            style="color: red; margin-top: 10px; display: none"
          ></div>
          <div
            id="register-success"
            style="color: green; margin-top: 10px; display: none"
          ></div>
        </form>
      </ion-content>
    </ion-modal>
  </body>
  <script type="module">
    import { items as importedItems } from "./data/trainingData.js";
    import ExerciseApiService from "./src/api.js";

    /**
     * 運動教學應用主類
     */
    class ExerciseApp {
      constructor() {
        this.api = new ExerciseApiService();
        this.currentItems = [];
        this.allItems = [];
        this.isLoadingMore = false;
        this.hasMoreData = true;
        this.currentPage = 1;
        this.itemsPerPage = 10;
        this.showFavoritesOnly = false;

        // DOM 元素
        this.template = document.querySelector(".list-item");
        this.list = document.querySelector("ion-list");
        this.searchbar = document.querySelector("ion-searchbar");
        this.categorySelect = document.querySelector("ion-select");
        this.resetBtn = document.getElementById("reset-category");
        this.loadingContainer = document.getElementById("loading-container");
        this.errorContainer = document.getElementById("error-container");
        this.emptyState = document.getElementById("empty-state");
        this.loadMoreBtn = document.getElementById("load-more-btn");

        this.init();
      }

      async init() {
        this.bindEvents();
        this.bindAuthEvents();
        await this.initializeApp();
      }

      /**
       * 初始化應用
       */
      async initializeApp() {
        this.showLoading(true);

        try {
          // 嘗試恢復用戶登入狀態
          const isLoggedIn = await this.api.initializeUserState();
          this.updateAuthUI();

          // 載入資料
          await this.loadExerciseData();

          this.showLoading(false);
        } catch (error) {
          this.showError("初始化失敗: " + error.message);
          console.error("初始化失敗:", error);

          // 降級到靜態資料
          console.log("降級使用靜態資料");
          this.allItems = [...importedItems];
          this.currentItems = [...this.allItems];
          this.populateCategorySelect();
          this.renderList();
          this.showLoading(false);
        }
      }

      /**
       * 載入運動資料
       */
      async loadExerciseData(isLoadMore = false) {
        try {
          if (!isLoadMore) {
            this.currentPage = 1;
            this.hasMoreData = true;
          }

          const params = {
            page: this.currentPage,
            limit: this.itemsPerPage,
          };

          const response = await this.api.getExercises(params);

          // 處理 API 回應
          let newItems = [];
          if (response.exercises) {
            newItems = response.exercises;
          } else if (response.data) {
            newItems = response.data;
          } else if (Array.isArray(response)) {
            newItems = response;
          } else {
            // 如果 API 格式不符預期，使用靜態資料
            console.warn("API 資料格式不符預期，使用靜態資料");
            newItems = importedItems;
          }

          if (!isLoadMore) {
            this.allItems = newItems;
            this.currentItems = [...newItems];
          } else {
            this.allItems = [...this.allItems, ...newItems];
            this.currentItems = [...this.currentItems, ...newItems];
          }

          // 檢查是否還有更多資料
          this.hasMoreData = newItems.length === this.itemsPerPage;

          this.populateCategorySelect();
          this.renderList();
        } catch (error) {
          if (!isLoadMore && this.allItems.length === 0) {
            // 首次載入失敗，使用靜態資料
            console.warn("API 載入失敗，使用靜態資料:", error);
            this.allItems = [...importedItems];
            this.currentItems = [...this.allItems];
            this.populateCategorySelect();
            this.renderList();
          } else {
            throw error;
          }
        }
      }

      /**
       * 綁定一般事件
       */
      bindEvents() {
        // 搜尋
        this.searchbar.addEventListener("ionInput", () => {
          this.applyFilters();
        });

        // 分類選擇
        this.categorySelect.addEventListener("ionChange", () => {
          this.applyFilters();
        });

        // 重設按鈕
        this.resetBtn.addEventListener("click", () => {
          this.resetFilters();
        });

        // 載入更多
        this.loadMoreBtn.addEventListener("click", () => {
          this.loadMore();
        });

        // 重試按鈕
        document.getElementById("retry-btn").addEventListener("click", () => {
          this.initializeApp();
        });

        // 收藏/全部切換
        document
          .getElementById("favorites-btn")
          .addEventListener("click", () => {
            this.toggleFavoritesMode();
          });

        document
          .getElementById("show-all-btn")
          .addEventListener("click", () => {
            this.showAllItems();
          });
      }

      /**
       * 綁定認證相關事件
       */
      bindAuthEvents() {
        // 登入按鈕
        document.getElementById("login-btn").addEventListener("click", () => {
          this.openLoginModal();
        });

        // 註冊按鈕
        document
          .getElementById("register-btn")
          .addEventListener("click", () => {
            this.openRegisterModal();
          });

        // 登出按鈕
        document.getElementById("logout-btn").addEventListener("click", () => {
          this.logout();
        });

        // 模態框關閉
        document
          .getElementById("close-login-modal")
          .addEventListener("click", () => {
            this.closeLoginModal();
          });

        document
          .getElementById("close-register-modal")
          .addEventListener("click", () => {
            this.closeRegisterModal();
          });

        // 表單提交
        document
          .getElementById("login-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            this.handleLogin(e);
          });

        document
          .getElementById("register-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            this.handleRegister(e);
          });
      }

      /**
       * 顯示/隱藏載入狀態
       */
      showLoading(show) {
        this.loadingContainer.style.display = show ? "block" : "none";
        this.errorContainer.style.display = "none";
        this.emptyState.style.display = "none";
      }

      /**
       * 顯示錯誤
       */
      showError(message) {
        this.loadingContainer.style.display = "none";
        this.errorContainer.style.display = "block";
        this.emptyState.style.display = "none";
        document.getElementById("error-message").textContent = message;
      }

      /**
       * 顯示空狀態
       */
      showEmpty() {
        this.loadingContainer.style.display = "none";
        this.errorContainer.style.display = "none";
        this.emptyState.style.display = "block";
      }

      /**
       * 取得獨特標籤
       */
      getUniqueTags() {
        const set = new Set();
        for (const item of this.allItems) {
          if (Array.isArray(item.tags)) {
            for (const tag of item.tags) set.add(tag);
          }
        }
        return Array.from(set);
      }

      /**
       * 填充分類選擇器
       */
      populateCategorySelect() {
        const unique = this.getUniqueTags();
        const addOptions =
          unique.length >= 2
            ? unique
            : unique.concat(["Beginner", "Intermediate", "Advanced"]);

        // 清除現有選項（除了"全部"）
        const options = this.categorySelect.querySelectorAll(
          'ion-select-option:not([value=""])'
        );
        options.forEach((option) => option.remove());

        for (const opt of addOptions) {
          const el = document.createElement("ion-select-option");
          el.value = opt;
          el.textContent = opt;
          this.categorySelect.appendChild(el);
        }
      }

      /**
       * 渲染清單
       */
      renderList(items = null) {
        const itemsToRender = items || this.currentItems;

        // 清空列表但保留模板
        this.list.innerHTML = "";
        this.list.appendChild(this.template);

        if (itemsToRender.length === 0) {
          this.showEmpty();
          return;
        }

        this.loadingContainer.style.display = "none";
        this.errorContainer.style.display = "none";
        this.emptyState.style.display = "none";

        for (const item of itemsToRender) {
          const node = this.template.cloneNode(true);
          node.style.display = "block";

          // 設置基本資訊
          node.querySelector(".item-title").textContent = item.title;
          node.querySelector(".item-subtitle").textContent = item.level;
          node.querySelector(".item-equipment").textContent = item.equipment;
          node.querySelector(".item-timeReq").textContent = item.timeReq;

          // 處理圖片和影片
          const img = node.querySelector(".item-image");
          const vid = node.querySelector(".item-video");
          if (img && item.imageUrl) {
            img.src = item.imageUrl;
          } else if (img) {
            img.style.display = "none";
          }

          if (vid && item.videoUrl) {
            vid.src = item.videoUrl;
            vid.style.display = "block";
          } else if (vid) {
            vid.style.display = "none";
          }

          // 處理標籤
          this.renderTags(node, item);

          // 處理收藏按鈕
          this.renderFavoriteButton(node, item);

          this.list.appendChild(node);
        }

        // 更新載入更多按鈕
        this.updateLoadMoreButton();
      }

      /**
       * 渲染標籤
       */
      renderTags(node, item) {
        const tagContainer = node.querySelector(".tag-container");
        tagContainer.innerHTML = "";

        if (Array.isArray(item.tags)) {
          for (const tag of item.tags) {
            const chip = document.createElement("ion-chip");
            chip.className = "tag-chip";
            chip.setAttribute("size", "small");
            chip.textContent = tag;

            chip.addEventListener("click", () => {
              this.categorySelect.value = tag;
              const ev = new Event("ionChange");
              this.categorySelect.dispatchEvent(ev);
            });

            tagContainer.appendChild(chip);
          }
        }
      }

      /**
       * 渲染收藏按鈕
       */
      renderFavoriteButton(node, item) {
        const favoriteBtn = node.querySelector(".favorite-btn");
        const favoriteIcon = node.querySelector(".favorite-icon");

        if (this.api.isLoggedIn()) {
          favoriteBtn.style.display = "block";

          const isFavorite = this.api.isFavorite(item.id);
          favoriteIcon.name = isFavorite ? "heart" : "heart-outline";
          favoriteBtn.style.color = isFavorite ? "#ff0000" : "";

          favoriteBtn.addEventListener("click", async () => {
            await this.toggleFavorite(item.id, favoriteBtn, favoriteIcon);
          });
        } else {
          favoriteBtn.style.display = "none";
        }
      }

      /**
       * 切換收藏狀態
       */
      async toggleFavorite(itemId, button, icon) {
        if (!this.api.isLoggedIn()) {
          this.showToast("請先登入", "warning");
          return;
        }

        try {
          const isFavorite = this.api.isFavorite(itemId);

          button.disabled = true;

          if (isFavorite) {
            await this.api.removeFavorite(itemId);
            icon.name = "heart-outline";
            button.style.color = "";
            this.showToast("已取消收藏", "success");
          } else {
            await this.api.addFavorite(itemId);
            icon.name = "heart";
            button.style.color = "#ff0000";
            this.showToast("已加入收藏", "success");
          }

          // 如果在收藏模式下，重新過濾列表
          if (this.showFavoritesOnly) {
            this.applyFilters();
          }
        } catch (error) {
          this.showToast("操作失敗: " + error.message, "danger");
        } finally {
          button.disabled = false;
        }
      }

      /**
       * 應用過濾器
       */
      applyFilters() {
        const query = (this.searchbar.value || "").toLowerCase();
        const category = this.categorySelect.value || "";

        let filtered = this.allItems.filter((item) => {
          // 搜尋過濾
          const matchesSearch =
            !query ||
            (item.title && item.title.toLowerCase().includes(query)) ||
            (item.level && item.level.toLowerCase().includes(query)) ||
            (item.equipment && item.equipment.toLowerCase().includes(query));

          // 分類過濾
          const matchesCategory =
            !category ||
            (Array.isArray(item.tags) && item.tags.includes(category)) ||
            (item.level && item.level === category);

          // 收藏過濾
          const matchesFavorites =
            !this.showFavoritesOnly || this.api.isFavorite(item.id);

          return matchesSearch && matchesCategory && matchesFavorites;
        });

        this.currentItems = filtered;
        this.renderList();
      }

      /**
       * 重設過濾器
       */
      resetFilters() {
        this.categorySelect.value = "";
        this.searchbar.value = "";

        const selEv = new Event("ionChange");
        this.categorySelect.dispatchEvent(selEv);

        const searchEv = new Event("ionInput");
        this.searchbar.dispatchEvent(searchEv);
      }

      /**
       * 載入更多資料
       */
      async loadMore() {
        if (this.isLoadingMore || !this.hasMoreData) return;

        this.isLoadingMore = true;
        this.setLoadMoreLoading(true);

        try {
          this.currentPage++;
          await this.loadExerciseData(true);
        } catch (error) {
          this.showToast("載入更多失敗: " + error.message, "danger");
        } finally {
          this.isLoadingMore = false;
          this.setLoadMoreLoading(false);
        }
      }

      /**
       * 更新載入更多按鈕
       */
      updateLoadMoreButton() {
        if (this.hasMoreData && this.currentItems.length > 0) {
          this.loadMoreBtn.style.display = "block";
        } else {
          this.loadMoreBtn.style.display = "none";
        }
      }

      /**
       * 設置載入更多按鈕狀態
       */
      setLoadMoreLoading(isLoading) {
        const text = this.loadMoreBtn.querySelector(".load-more-text");
        const spinner = this.loadMoreBtn.querySelector("ion-spinner");

        if (isLoading) {
          text.style.display = "none";
          spinner.style.display = "block";
          this.loadMoreBtn.disabled = true;
        } else {
          text.style.display = "block";
          spinner.style.display = "none";
          this.loadMoreBtn.disabled = false;
        }
      }

      /**
       * 切換收藏模式
       */
      toggleFavoritesMode() {
        if (!this.api.isLoggedIn()) {
          this.showToast("請先登入查看收藏", "warning");
          return;
        }

        this.showFavoritesOnly = true;
        this.updateFavoritesUI();
        this.applyFilters();
      }

      /**
       * 顯示全部項目
       */
      showAllItems() {
        this.showFavoritesOnly = false;
        this.updateFavoritesUI();
        this.applyFilters();
      }

      /**
       * 更新收藏相關UI
       */
      updateFavoritesUI() {
        const favoritesBtn = document.getElementById("favorites-btn");
        const showAllBtn = document.getElementById("show-all-btn");

        if (this.showFavoritesOnly) {
          favoritesBtn.style.display = "none";
          showAllBtn.style.display = "block";
        } else {
          favoritesBtn.style.display = this.api.isLoggedIn() ? "block" : "none";
          showAllBtn.style.display = "none";
        }
      }

      // ==================== 認證相關方法 ====================

      /**
       * 更新認證UI
       */
      updateAuthUI() {
        const loginBtn = document.getElementById("login-btn");
        const registerBtn = document.getElementById("register-btn");
        const logoutBtn = document.getElementById("logout-btn");
        const userWelcome = document.getElementById("user-welcome");
        const favoritesBtn = document.getElementById("favorites-btn");

        if (this.api.isLoggedIn()) {
          const user = this.api.getCurrentUser();
          loginBtn.style.display = "none";
          registerBtn.style.display = "none";
          logoutBtn.style.display = "block";
          favoritesBtn.style.display = "block";
          userWelcome.style.display = "block";
          userWelcome.textContent = `歡迎，${user.username || user.email}`;
        } else {
          loginBtn.style.display = "block";
          registerBtn.style.display = "block";
          logoutBtn.style.display = "none";
          favoritesBtn.style.display = "none";
          userWelcome.style.display = "none";
          this.showFavoritesOnly = false;
        }

        this.updateFavoritesUI();
        this.renderList(); // 重新渲染以更新收藏按鈕
      }

      /**
       * 開啟登入模態框
       */
      openLoginModal() {
        const modal = document.getElementById("login-modal");
        modal.isOpen = true;
        this.clearLoginForm();
      }

      /**
       * 關閉登入模態框
       */
      closeLoginModal() {
        const modal = document.getElementById("login-modal");
        modal.isOpen = false;
      }

      /**
       * 開啟註冊模態框
       */
      openRegisterModal() {
        const modal = document.getElementById("register-modal");
        modal.isOpen = true;
        this.clearRegisterForm();
      }

      /**
       * 關閉註冊模態框
       */
      closeRegisterModal() {
        const modal = document.getElementById("register-modal");
        modal.isOpen = false;
      }

      /**
       * 處理登入
       */
      async handleLogin(event) {
        const form = event.target;
        const formData = new FormData(form);
        const username = formData.get("username");
        const password = formData.get("password");

        const submitBtn = document.getElementById("login-submit-btn");
        const buttonText = submitBtn.querySelector(".login-button-text");
        const spinner = submitBtn.querySelector("ion-spinner");
        const errorDiv = document.getElementById("login-error");

        try {
          this.setButtonLoading(submitBtn, buttonText, spinner, true);
          errorDiv.style.display = "none";

          await this.api.login(username, password);

          this.updateAuthUI();
          this.closeLoginModal();
          this.showToast("登入成功！", "success");

          // 重新載入以獲取用戶相關資料
          this.applyFilters();
        } catch (error) {
          errorDiv.textContent =
            error.message || "登入失敗，請檢查用戶名和密碼";
          errorDiv.style.display = "block";
        } finally {
          this.setButtonLoading(submitBtn, buttonText, spinner, false);
        }
      }

      /**
       * 處理註冊
       */
      async handleRegister(event) {
        const form = event.target;
        const formData = new FormData(form);
        const userData = {
          username: formData.get("username"),
          email: formData.get("email"),
          password: formData.get("password"),
        };

        const confirmPassword = formData.get("confirmPassword");
        const submitBtn = document.getElementById("register-submit-btn");
        const buttonText = submitBtn.querySelector(".register-button-text");
        const spinner = submitBtn.querySelector("ion-spinner");
        const errorDiv = document.getElementById("register-error");
        const successDiv = document.getElementById("register-success");

        // 驗證密碼
        if (userData.password !== confirmPassword) {
          errorDiv.textContent = "密碼與確認密碼不一致";
          errorDiv.style.display = "block";
          successDiv.style.display = "none";
          return;
        }

        try {
          this.setButtonLoading(submitBtn, buttonText, spinner, true);
          errorDiv.style.display = "none";
          successDiv.style.display = "none";

          await this.api.register(userData);

          successDiv.textContent = "註冊成功！請使用您的帳號登入。";
          successDiv.style.display = "block";
          form.reset();

          setTimeout(() => {
            this.closeRegisterModal();
            this.openLoginModal();
          }, 2000);
        } catch (error) {
          errorDiv.textContent = error.message || "註冊失敗，請稍後再試";
          errorDiv.style.display = "block";
        } finally {
          this.setButtonLoading(submitBtn, buttonText, spinner, false);
        }
      }

      /**
       * 登出
       */
      async logout() {
        try {
          await this.api.logout();
          this.updateAuthUI();
          this.showToast("已成功登出", "success");
        } catch (error) {
          console.error("登出失敗:", error);
          this.showToast("登出時發生錯誤", "warning");
        }
      }

      /**
       * 設置按鈕載入狀態
       */
      setButtonLoading(button, textElement, spinner, isLoading) {
        if (isLoading) {
          textElement.style.display = "none";
          spinner.style.display = "block";
          button.disabled = true;
        } else {
          textElement.style.display = "block";
          spinner.style.display = "none";
          button.disabled = false;
        }
      }

      /**
       * 清空登入表單
       */
      clearLoginForm() {
        document.getElementById("login-form").reset();
        document.getElementById("login-error").style.display = "none";
      }

      /**
       * 清空註冊表單
       */
      clearRegisterForm() {
        document.getElementById("register-form").reset();
        document.getElementById("register-error").style.display = "none";
        document.getElementById("register-success").style.display = "none";
      }

      /**
       * 顯示提示訊息
       */
      showToast(message, color = "primary") {
        const toast = document.createElement("ion-toast");
        toast.message = message;
        toast.duration = 3000;
        toast.color = color;
        document.body.appendChild(toast);
        toast.present();
      }
    }

    // 初始化應用
    window.exerciseApp = new ExerciseApp();
  </script>
</html>
